<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ডিভাইস ম্যানেজার অ্যাডমিন</title>
  <style>
    :root{font-family: 'Segoe UI', Roboto, Arial, sans-serif}
    body{max-width:1000px;margin:18px auto;padding:18px}
    h1{font-size:20px;margin-bottom:6px}
    .card{border:1px solid #ddd;padding:12px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.04)}
    label{display:block;margin-top:8px;font-weight:600}
    input,select,button{padding:8px;border-radius:6px;border:1px solid #ccc;font-size:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1 1 220px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #eee;padding:8px;text-align:left}
    th{background:#f7f7f7}
    .actions button{margin-right:6px}
    .small{font-size:13px;color:#555}
    .btn{cursor:pointer}
    .btn-primary{background:#0b74de;color:#fff;border:none}
    .btn-danger{background:#e04b4b;color:#fff;border:none}
    .btn-ghost{background:transparent;border:1px solid #ccc}
    .toggle{cursor:pointer}
    .topbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .search{min-width:220px}
    .controls{display:flex;gap:8px}
    pre{background:#f6f8fa;padding:8px;border-radius:6px;overflow:auto}
    @media(max-width:600px){.row{flex-direction:column}}
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
  <h1>ডিভাইস ম্যানেজার অ্যাডমিন প্যানেল</h1>
  <div class="card">
    <div class="topbar">
      <div class="search">
        <input id="searchInput" placeholder="Search device_id বা key লিখুন" style="width:100%" />
      </div>
      <div class="controls">
        <button class="btn btn-primary" id="exportBtn">JSON এক্সপোর্ট</button>
        <button class="btn btn-ghost" id="importBtn">JSON ইনপোর্ট</button>
        <button class="btn btn-ghost" id="clearStorage">LocalStorage ক্লিয়ার</button>
      </div>
    </div>

    <form id="deviceForm" style="margin-top:12px">
      <div class="row">
        <div class="col">
          <label>ডিভাইস আইডি</label>
          <input id="device_id" required />
        </div>
        <div class="col">
          <label>Key</label>
          <input id="key" required />
        </div>
        <div class="col">
          <label>Expiry Date</label>
          <input id="expirydate" type="date" />
        </div>
        <div class="col">
          <label>Allow Offline</label>
          <select id="allowoffline">
            <option value="true">Allowed (true)</option>
            <option value="false">Not allowed (false)</option>
          </select>
        </div>
      </div>
      <div style="margin-top:10px">
        <button class="btn btn-primary" id="saveBtn">ক্রিয়েট / আপডেট করুন</button>
        <button type="button" class="btn btn-ghost" id="resetBtn">রিসেট</button>
      </div>
    </form>

    <table id="devicesTable">
      <thead>
        <tr>
          <th>Device ID</th>
          <th>Key</th>
          <th>Expiry Date</th>
          <th>AllowOffline</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <p class="small">CRUD + Firebase Realtime Database সমর্থিত।</p>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSy8m3iuH0de6K31q58DlDcm4RFsJfNTt0Y",
      authDomain: "xsiam-8cd91.firebaseapp.com",
      databaseURL: "https://xsiam-8cd91-default-rtdb.firebaseio.com",
      projectId: "xsiam-8cd91",
      storageBucket: "xsiam-8cd91.appspot.com",
      messagingSenderId: "20529006593",
      appId: "1:20529006593:web:xxxxx"
    };
    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref('devices');

    // DOM
    const tBody = document.querySelector('#devicesTable tbody');
    const form = document.getElementById('deviceForm');
    const deviceIdInput = document.getElementById('device_id');
    const keyInput = document.getElementById('key');
    const expiryInput = document.getElementById('expirydate');
    const allowSelect = document.getElementById('allowoffline');
    const saveBtn = document.getElementById('saveBtn');
    const resetBtn = document.getElementById('resetBtn');
    const searchInput = document.getElementById('searchInput');

    let devices = [];
    let editIndex = -1;

    // Firebase থেকে লোড
    dbRef.on('value', snapshot => {
      devices = snapshot.val() ? Object.values(snapshot.val()) : [];
      renderTable();
    });

    function renderTable(filter=''){
      tBody.innerHTML = '';
      const list = devices.filter(d => {
        if(!filter) return true;
        const q = filter.toLowerCase();
        return d.device_id.toLowerCase().includes(q) || (d.key||'').toLowerCase().includes(q);
      });
      list.forEach((d, idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${d.device_id}</td>
          <td>${d.key}</td>
          <td>${d.expirydate || ''}</td>
          <td><input type="checkbox" ${d.Allowoffline? 'checked':''} data-idx="${idx}" class="allow-toggle" /></td>
          <td class="actions">
            <button class="btn btn-ghost" data-action="edit" data-idx="${idx}">Edit</button>
            <button class="btn btn-danger" data-action="delete" data-idx="${idx}">Delete</button>
          </td>
        `;
        tBody.appendChild(tr);
      });
      document.querySelectorAll('.allow-toggle').forEach(el => {
        el.addEventListener('change', e => {
          const i = Number(el.getAttribute('data-idx'));
          devices[i].Allowoffline = el.checked;
          saveToFirebase();
        });
      });
      document.querySelectorAll('button[data-action]').forEach(btn => {
        btn.addEventListener('click', e => {
          const action = btn.getAttribute('data-action');
          const i = Number(btn.getAttribute('data-idx'));
          if(action === 'edit') startEdit(i);
          if(action === 'delete') doDelete(i);
        });
      });
    }

    function startEdit(i){
      const d = devices[i];
      editIndex = i;
      deviceIdInput.value = d.device_id;
      keyInput.value = d.key;
      expiryInput.value = d.expirydate.split('-').reverse().join('-');
      allowSelect.value = d.Allowoffline ? 'true':'false';
      saveBtn.textContent = 'আপডেট করুন';
    }

    function doDelete(i){
      if(!confirm('আপনি কি এই ডিভাইস মুছে ফেলতে চান?')) return;
      devices.splice(i,1);
      saveToFirebase();
    }

    function resetForm(){
      editIndex = -1;
      form.reset();
      saveBtn.textContent = 'ক্রিয়েট / আপডেট করুন';
    }

    function saveToFirebase(){
      const obj = {};
      devices.forEach(d=>{
        obj[d.device_id] = d;
      });
      dbRef.set(obj);
    }

    form.addEventListener('submit', e => {
      e.preventDefault();
      const device_id = deviceIdInput.value.trim();
      const key = keyInput.value.trim();
      const expiry = expiryInput.value ? expiryInput.value.split('-').reverse().join('-') : '';
      const allow = allowSelect.value === 'true';
      const payload = { device_id, key, expirydate: expiry, Allowoffline: allow };
      if(editIndex >=0){
        devices[editIndex] = payload;
      }else{
        const idx = devices.findIndex(d=>d.device_id===device_id);
        if(idx>=0){ devices[idx] = payload; }
        else{ devices.push(payload); }
      }
      saveToFirebase();
      resetForm();
    });

    resetBtn.addEventListener('click', resetForm);
    searchInput.addEventListener('input', e=> renderTable(e.target.value));
  </script>
</body>
</html>
